---
import Layout from "../layouts/Layout.astro";
import CvForExport from "../components/CvForExport.astro";
---

<script>
  // Lazy-loaded PDF export functionality - only loads jsPDF when needed
  let isLoading = false;

  async function downloadPDF() {
    // Prevent multiple simultaneous downloads
    if (isLoading) return;
    
    const downloadButton = document.getElementById("download-btn");
    const buttonText = downloadButton?.querySelector('.button-text');
    const loadingSpinner = downloadButton?.querySelector('.loading-spinner');
    
    try {
      // Show loading state
      isLoading = true;
      if (buttonText) buttonText.textContent = "Generating PDF...";
      if (loadingSpinner) (loadingSpinner as HTMLElement).style.display = "inline-block";
      if (downloadButton) (downloadButton as HTMLButtonElement).disabled = true;

      // Dynamically import jsPDF only when needed (saves 359KB on page load!)
      const { jsPDF } = await import("jspdf");
      
      const pdf = new jsPDF({
        orientation: "portrait",
        format: "a4",
        unit: "px",
      });

      const pdfContent = document.getElementById("cv-export")?.innerHTML;
      if (!pdfContent) {
        throw new Error("CV content not found");
      }

      // Generate PDF
      pdf.html(pdfContent, {
        filename: "ryan_harman_cv.pdf",
        margin: 15,
        autoPaging: "text",
        x: 0,
        y: 0,
        width: 400,
        windowWidth: 675,
        html2canvas: {
          letterRendering: true,
          onclone: (doc) => {
            doc
              .getElementsByTagName("body")[0]
              ?.classList.add("pdf-font-size-scaler");
          },
        },
        callback: (doc) => {
          doc.save("ryan_harman_cv.pdf");
          // Reset loading state after successful download
          resetButtonState();
        },
      });
      
    } catch (error) {
      console.error("PDF generation failed:", error);
      // Show error state
      if (buttonText) buttonText.textContent = "Export Failed - Try Again";
      setTimeout(resetButtonState, 3000); // Reset after 3 seconds
    }
  }

  function resetButtonState() {
    isLoading = false;
    const downloadButton = document.getElementById("download-btn");
    const buttonText = downloadButton?.querySelector('.button-text');
    const loadingSpinner = downloadButton?.querySelector('.loading-spinner');
    
    if (buttonText) buttonText.textContent = "Export to PDF";
    if (loadingSpinner) (loadingSpinner as HTMLElement).style.display = "none";
    if (downloadButton) (downloadButton as HTMLButtonElement).disabled = false;
  }

  // Set up event listener when DOM is ready
  document.addEventListener('astro:page-load', () => {
    const downloadButton = document.getElementById("download-btn");
    if (downloadButton) {
      downloadButton.addEventListener("click", downloadPDF);
    }
  });
</script>

<Layout currentPage="/cv" hideAboutMeArticle={true}>
  <span class="font-mono text-sm"
    >the cv export isn't perfect on windows right now, or if you have
    accessibility scaling, get in touch if it doesn't look right!</span
  >
  <CvForExport />
  <button
    id="download-btn"
    class="fixed bottom-4 right-4 bg-background text-primary shadow-sm group my-4 px-4 py-2 rounded-md border border-primary/50 hover:border-primary font-medium tracking-tight transition-all disabled:opacity-50 disabled:cursor-not-allowed"
  >
    <!-- Loading spinner (hidden by default) -->
    <svg 
      class="loading-spinner animate-spin -ml-1 mr-2 h-4 w-4 text-primary inline-block" 
      style="display: none;" 
      xmlns="http://www.w3.org/2000/svg" 
      fill="none" 
      viewBox="0 0 24 24"
    >
      <circle 
        class="opacity-25" 
        cx="12" 
        cy="12" 
        r="10" 
        stroke="currentColor" 
        stroke-width="4"
      ></circle>
      <path 
        class="opacity-75" 
        fill="currentColor" 
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
      ></path>
    </svg>
    <span class="button-text">Export to PDF</span>
  </button>
</Layout>
